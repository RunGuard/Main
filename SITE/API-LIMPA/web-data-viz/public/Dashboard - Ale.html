<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD-Ale | RunGuard</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/dashstyle.css">
    <link rel="stylesheet" href="css/style_ale.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
    <button class="botao-chat" onclick="abrirChat()"><img style="width: 6vh;" src="imagens/robo.png" alt=""></button>

    <div id="janelaChat" class="janela-chat">
        <div class="cabecalho-chat">
            <div style="display: flex; align-items: center;">
                <img style="width: 100%;" src="imagens/robo-branco.png" alt="Perfil do assistente">
                <span style="font-size: 1.5em;">Guardinha</span>
            </div>
            <button style="background: none; border: none; color: white; cursor: pointer; font-size: 2em;" onclick="fecharChat()">᰽</button>
        </div>
        <div id="corpoChat" class="corpo-chat">
            <div class="mensagem assistente">
                Olá! <br>
                Me chamo Guardinha e sou a assistente virtual da RunGuard. <br>
                <b>Como posso ajudar?</b>
            </div>
            <div class="hora-mensagem assistente" id="horaDeAbertura"></div>
        </div>
        <div class="rodape-chat">
            <input type="text" id="entradaUsuario" placeholder="Escreva sua mensagem..." />
            <button onclick="gerarResposta()">⟹</button>
        </div>
    </div>

    <nav>
        <ul>
            <li>
                <a href="index.html" class="logo">
                    <img src="imagens/logo.png" alt="Logo RunGuard">
                    <span class="nav-item">RUNGUARD</span>
                </a>
            </li>
            <li><a href="index.html"><i class="fas fa-home"></i><span class="nav-item">Home</span></a></li>
            <li><a href="Dashboard - Ale.html"><i class="fas fa-chart-line"></i><span class="nav-item">Dashboard 1</span></a></li>
            <li><a href="Dashboard - Anne.html"><i class="fas fa-chart-bar"></i><span class="nav-item">Dashboard 2</span></a></li>
            <li><a href="Dashboard - Diego.html"><i class="fas fa-chart-pie"></i><span class="nav-item">Dashboard 3</span></a></li>
            <li><a href="Dashboard - Guilherme.html"><i class="fas fa-chart-column"></i><span class="nav-item">Dashboard 4</span></a></li>
            <li><a href="Dashboard - Ilys.html"><i class="fas fa-chart-simple"></i><span class="nav-item">Dashboard 5</span></a></li>
            <li><a href="Dashboard - Lucas.html"><i class="fas fa-chart-area"></i><span class="nav-item">Dashboard 6</span></a></li>
            <li><a href="insights-run-guard.pdf" download><i class="fas fa-file-pdf"></i><span class="nav-item">Baixe seus relatórios!</span></a></li>
            <li><a href="#" class="sair"><i class="fas fa-sign-out-alt"></i><span class="nav-item">Sair</span></a></li>
        </ul>
    </nav>

    <div id="charts-container">
        <div id="chart-packets" class="chart"></div>
        <div id="chart-ping" class="chart"></div>
        <div id="chart-bytes" class="chart"></div>
        <div id="chart-cpu" class="chart"></div>
    </div>
  <div>

      <h1 style="size: 2px;">Selecione um Servidor</h1>
      <select id="selectServidor">
          <option value="">Carregando...</option>
      </select>
      <button onclick="listarServidor()" class="botao-atualizar">Atualizar Servidores</button>
  </div>
    
    <div class="alert-container">
        <div class="alert-content">
            <h2>Alertas de Monitoramento</h2>
            <p><strong>Perda na Última Hora:</strong></p>
            <p>Pacotes em risco: <span id="perdaPacotes" class="highlight"></span></p>
            <p>Bytes em risco: <br><span id="perdaBytes" class="highlight"></span></p>
            <p><strong>Eventos de Latência Alta:</strong></p>
            <p>Latência alta: <span id="pingAlerta" class="highlight"></span></p>
        </div>
    </div>

<script>
//     function obterFkEquipamento() {
//     const selectElement = document.getElementById("equipamentoSelect");
//     return selectElement ? selectElement.value : null;
// }

//    va fkEquipamento = 5;
   
   

// Busca os dados e atualiza os gráficos
async function buscarDadosGrafico(fkEquipamento) {
    fetch(`/ale/obterDados/${fkEquipamento}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao buscar dados: ' + response.statusText);
            }
            return response.json();
        })
        try {
        const response = await fetch(`/ale/obterDados/${fkEquipamento}`);
        
        if (!response.ok) {
            throw new Error('Erro ao buscar dados: ' + response.statusText);
        }

        const data = await response.json();
        // console.log(JSON.stringify(data, null, 2)); // Log detalhado da estrutura

        if (Array.isArray(data) && data.length > 0) {
            const bytesEnviados = data.map(item => {
                console.log(item); // Log para verificar a estrutura
                return item.bytes_enviados !== undefined ? item.bytes_enviados : null; // Retorna null se não existir
            });
            const ultimoDado = data[data.length - 1];
            // const ultimoDado = data[data.length - 1];

            const bytesRecebidos = data.map(item => item.bytes_recebidos !== undefined ? item.bytes_recebidos : null);
            const pacotesEnviados = ultimoDado.pacotes_enviados || null;
            const pacotesRecebidos = ultimoDado.pacotes_recebidos || null;
            const ping = ultimoDado.ping || 0; // Definir como 0 se for undefined ou null
            const usoDoCPU= ultimoDado.usoCPU || 0;
            const horario = data.map(item => item.horario !== undefined ? item.horario : null); // Pega o último valor de uso da CPU

            // console.log("Uso da CPU:", usoCPU);

            // Log para verificar os dados extraídos
            console.log("Bytes Enviados:", bytesEnviados);
            console.log("Bytes Recebidos:", bytesRecebidos);
            console.log("Pacotes Enviados:", pacotesEnviados);
            console.log("Pacotes Recebidos:", pacotesRecebidos);
            console.log("Ping:", ping);
            console.log("Uso do CPU:", usoDoCPU);
            console.log("Horário:", horario);

            // Atualize os gráficos
            atualizarGraficoBytes(bytesEnviados,bytesRecebidos,horario);
            atualizarGraficoCPU(usoDoCPU);
            atualizarGraficoPackets(pacotesRecebidos,pacotesEnviados);
            atualizarGraficoPing(ping);
        } else {
            console.error('Formato de dados inesperado ou dados vazios:', data);
        }
    } catch (error) {
        console.error("Erro ao buscar dados:", error);
    }
}

// Lista os servidores e inicializa a seleção
async function listarServidor() {
    // const fkEquipamento = obterFkEquipamento(); // Substitua por como você obtém o valor
    fetch('/ale/buscarServidor')
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao buscar servidores: ' + response.statusText);
            }
            return response.json();
        })
        .then(servidores => {
            const selectServidor = document.getElementById('selectServidor');
            
            selectServidor.innerHTML = '<option disabled selected value="">Selecione um Servidor</option>';
            
            servidores.forEach(servidor => {
                const option = document.createElement('option');
                option.value = servidor.idEquipamento; 
                option.textContent = servidor.nomeEquipamento;
                selectServidor.appendChild(option); 
            });

            selectServidor.addEventListener('change', function () {
                fkEquipamento = this.value;
                if (fkEquipamento) {
                    console.log(`Servidor selecionado: ${fkEquipamento}`);
                    buscarDadosGrafico(fkEquipamento); 
                } else {
                    console.warn("Nenhum servidor foi selecionado.");
                }
            });
        })
        .catch(error => {
            console.error("Erro ao carregar servidores:", error);
        });
}





// Atualiza gráficos específicos
let chartBytes; // Variável global para armazenar a instância do gráfico

function atualizarGraficoBytes(bytesEnviados, bytesRecebidos, horarios) {
    document.addEventListener("DOMContentLoaded", () => {
    listarServidor(); // Inicializa a listagem de servidores após o DOM estar pronto
});
    if (!chartBytes) {
        // Configuração inicial do gráfico
        const options = {
            chart: {
                type: 'line',
                height: 350,
                toolbar: { show: false }
            },
            series: [
                {
                    name: 'Bytes Enviados',
                    data: bytesEnviados
                },
                {
                    name: 'Bytes Recebidos',
                    data: bytesRecebidos
                }
            ],
            xaxis: {
                categories: horarios, // Eixo X com os horários
                title: { text: 'Horário' }
            },
            yaxis: {
                title: { text: 'Bytes' },
                min: 0
            },
            colors: ['#FFD700', '#1E90FF'], // Amarelo e Azul
            stroke: { curve: 'smooth' },
            markers: { size: 4 },
            tooltip: { shared: true, intersect: false }
        };

        // Inicializa o gráfico
        chartBytes = new ApexCharts(document.querySelector("#chart-bytes"), options);
        chartBytes.render();
    } 
    else {
        chartBytes.updateOptions({
            series: [
                { name: 'Bytes Enviados', data: bytesEnviados },
                { name: 'Bytes Recebidos', data: bytesRecebidos }
            ],
            xaxis: { categories: horarios }
        });
    }
}

function atualizarGraficoPackets(pacotesEnviados = 0, pacotesRecebidos = 0) {
    const contadorEnviados = document.getElementById("contador-enviados");
    const contadorRecebidos = document.getElementById("contador-recebidos");

    if (contadorEnviados && contadorRecebidos) {
        contadorEnviados.innerText = pacotesEnviados + " Pacotes Enviados";
        contadorRecebidos.innerText = pacotesRecebidos + " Pacotes Recebidos";

        // Alterar a cor com base nos valores
        contadorEnviados.style.color = pacotesEnviados < 10 ? "#E74C3C" : "#FFC300"; // Vermelho ou Amarelo
        contadorRecebidos.style.color = pacotesRecebidos < 10 ? "#E74C3C" : "#3498DB"; // Vermelho ou Azul
    }
    }


// Atualização contínua a cada 2 segundos usando dados reais
setInterval( // Substitua por sua função real
    atualizarGraficoPackets()
, 2000);

// Renderizar os contadores no lugar do gráfico de pacotes
document.addEventListener('DOMContentLoaded', function () {
    const monitoramentoPacotes = document.getElementById("chart-packets");
    monitoramentoPacotes.innerHTML = `
        <div>
            <h2 style="color: #fff;">Monitoramento de Pacotes</h2>
            <p id="contador-enviados" style="color: #FFC300; font-size: 1.5rem;">0 Pacotes Enviados</p>
            <p id="contador-recebidos" style="color: #3498DB; font-size: 1.5rem;">0 Pacotes Recebidos</p>
        </div>
    `;
});



let chartCPU; // Variável global para armazenar a instância do gráfico

function atualizarGraficoCPU(usoDoCPU) {
    const chartElement = document.querySelector("#chart-cpu");

    if (!chartElement) {
        console.error("Elemento do gráfico não encontrado no DOM: #chart-cpu");
        return;
    }

    // Se o gráfico ainda não foi criado, inicialize-o
    if (!chartCPU) {
        const options = {
            chart: {
                type: 'radialBar',
                height: 350
            },
            series: [usoDoCPU], // Valor inicial do uso da CPU
            labels: ['Uso da CPU'], // Nome do indicador
            colors: ['#1E90FF'], // Azul
            plotOptions: {
                radialBar: {
                    hollow: {
                        size: '60%' // Define o tamanho do círculo central
                    },
                    dataLabels: {
                        name: {
                            fontSize: '18px',
                            fontWeight: 'bold',
                            color: '#333'
                        },
                        value: {
                            fontSize: '16px',
                            fontWeight: 'bold',
                            formatter: function (val) {
                                return `${val}%`; // Exibe o valor como porcentagem
                            }
                        }
                    }
                }
            }
        };

        // Inicializa o gráfico radial
        chartCPU = new ApexCharts(chartElement, options);
        chartCPU.render();
    } else {
        // Atualiza o valor do gráfico radial
        chartCPU.updateSeries([usoDoCPU]);
    }
}

// Simulação de valores dinâmicos para teste
setInterval(() => { 
    const usoDoCPU = [0];// Gera valores aleatórios de 0 a// Gera um valor aleatório entre 0 e 100
    atualizarGraficoCPU(usoDoCPU);
}, 2000); // Atualiza a cada 2 segundos
 // Atualiza a cada 2 segundos



 function atualizarGraficoPing(ping) {
    const contadorPing = document.getElementById("contador-ping");

    if (contadorPing) {
        contadorPing.innerText = ping + " ms de Latência (Ping)";

        // Alterar a cor com base no valor do ping
        contadorPing.style.color = ping > 100 ? "#E74C3C" : "#2ECC71"; // Vermelho se > 100, Verde se <= 100
    }
}

// Atualização contínua a cada 2 segundos com dados reais
setInterval( () => {
    const ping = [0];;// Você precisa adaptar esta função com os dados da API
    atualizarGraficoPing()
}, 2000);

// Renderizar o contador de ping no lugar do gráfico
document.addEventListener('DOMContentLoaded', function () {
    const monitoramentoPacotes = document.getElementById("chart-ping");
    monitoramentoPacotes.innerHTML = `
        <div>
            <h2 style="color: #fff;">Monitoramento de Latência (Ping)</h2>
            <p id="contador-ping" style="color: #2ECC71; font-size: 1.5rem;">0 ms de Latência (Ping)</p>
        </div>
    `;
});

document.addEventListener("DOMContentLoaded", () => {
    listarServidor();
});













// Atualiza os dados a cada 5 minutos

// Função para monitorar dados
function monitorarDados() {
        const minBytes = 1024 * 1024; // 1 MB em bytes
        const minPacotes = 10;
        const maxPing = 100; // Latência máxima permitida
    
        // Dados fictícios para teste
        const dados = {
            ping: 993,
            bytesEnviados: 500000,
            bytesRecebidos: 920000,
            pacotesEnviados: 5,
            pacotesRecebidos: 8,
        };
    
        const { ping, bytesEnviados, bytesRecebidos, pacotesEnviados, pacotesRecebidos } = dados;
    
        const bytesEnviadosMB = (bytesEnviados / minBytes).toFixed(2);
        const bytesRecebidosMB = (bytesRecebidos / minBytes).toFixed(2);
    
        const perdaBytesMsg = [
            bytesEnviados < minBytes && `${bytesEnviadosMB} MB enviados (Abaixo de 1 MB)`,
            bytesRecebidos < minBytes && `${bytesRecebidosMB} MB recebidos (Abaixo de 1 MB)`
        ].filter(Boolean).join("<br>");
    
        const perdaPacotesMsg = [
            pacotesEnviados < minPacotes && `${pacotesEnviados} pacotes enviados (Abaixo de 10)`,
            pacotesRecebidos < minPacotes && `${pacotesRecebidos} pacotes recebidos (Abaixo de 10)`
        ].filter(Boolean).join("<br>");
    
        const pingMsg = ping > maxPing ? `${ping} ms (Latência acima de 100 ms)` : "";
    
        atualizarTextoElemento("perdaBytes", perdaBytesMsg || "Nenhum alerta", perdaBytesMsg ? "#E74C3C" : "lightgreen");
        atualizarTextoElemento("perdaPacotes", perdaPacotesMsg || "Nenhum alerta", perdaPacotesMsg ? "#E74C3C" : "lightgreen");
        atualizarTextoElemento("pingAlerta", pingMsg || "Nenhum alerta", pingMsg ? "#E74C3C" : "lightgreen");
    }
    
    // Função auxiliar para atualizar elementos HTML
    function atualizarTextoElemento(id, texto, cor) {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.innerHTML = texto;
            elemento.style.color = cor;
        }
    }
    

</script>

</body>

</html>