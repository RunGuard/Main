<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD-Ale | RunGuard</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/dashstyle.css">
    <link rel="stylesheet" href="css/style_ale.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
</head>
<body>
    <button class="botao-chat" onclick="abrirChat()"><img style="width: 6vh;" src="imagens/robo.png" alt=""></button>
    
    <div id="janelaChat" class="janela-chat">
        <div class="cabecalho-chat">
            <div style="display: flex; align-items: center;">
                <img style="width: 100%;" src="imagens/robo-branco.png" alt="Perfil do assistente">
                <span style="font-size: 1.5em;">Guardinha</span>
            </div>
            <button style="background: none; border: none; color: white; cursor: pointer; font-size: 2em;" onclick="fecharChat()">᰽</button>
        </div>
        <div id="corpoChat" class="corpo-chat">
            <div class="mensagem assistente">
                Olá! <br>
                Me chamo Guardinha e sou a assistente virtual da RunGuard. <br>
                <b>Como posso ajudar?</b>
            </div>
            <div class="hora-mensagem assistente" id="horaDeAbertura"></div>
        </div>
        <div class="rodape-chat">
            <input type="text" id="entradaUsuario" placeholder="Escreva sua mensagem..." />
            <button onclick="gerarResposta()">⟹</button>
        </div>
    </div>

    <nav>
        <ul>
            <li>
                <a href="index.html" class="logo">
                    <img src="imagens/logo.png" alt="Logo RunGuard">
                    <span class="nav-item">RUNGUARD</span>
                </a>
            </li>
            <li><a href="index.html"><i class="fas fa-home"></i><span class="nav-item">Home</span></a></li>
            <li><a href="Dashboard - Ale.html"><i class="fas fa-chart-line"></i><span class="nav-item">Dashboard 1</span></a></li>
            <li><a href="Dashboard - Anne.html"><i class="fas fa-chart-bar"></i><span class="nav-item">Dashboard 2</span></a></li>
            <li><a href="Dashboard - Diego.html"><i class="fas fa-chart-pie"></i><span class="nav-item">Dashboard 3</span></a></li>
            <li><a href="Dashboard - Guilherme.html"><i class="fas fa-chart-column"></i><span class="nav-item">Dashboard 4</span></a></li>
            <li><a href="Dashboard - Ilys.html"><i class="fas fa-chart-simple"></i><span class="nav-item">Dashboard 5</span></a></li>
            <li><a href="Dashboard - Lucas.html"><i class="fas fa-chart-area"></i><span class="nav-item">Dashboard 6</span></a></li>
            <li><a href="insights-run-guard.pdf" download><i class="fas fa-file-pdf"></i><span class="nav-item">Baixe seus relatórios!</span></a></li>
            <li><a href="#" class="sair"><i class="fas fa-sign-out-alt"></i><span class="nav-item">Sair</span></a></li>
        </ul>
    </nav>

    <div id="charts-container">
        <div id="chart-packets" class="chart"></div>
        <div id="chart-pie" class="chart"></div>
        <div id="chart-bytes" class="chart"></div>
        
        <div id="chart-cpu" class="chart"></div>
       
    </div>

    <div class="alert-container">
        <div class="alert-content">
            <h2>Alertas de Monitoramento</h2>
            <p><strong>Perda na Última Hora:</strong></p>
            <p>Pacotes em risco: <span id="perdaPacotes" class="highlight"></span></p>
            <p>Bytes em risco: <br><span id="perdaBytes" class="highlight"></span></p>
            <p><strong>Eventos de Latência Alta:</strong></p>
            <p>Latência alta: <span id="pingAlerta" class="highlight"></span></p>
        </div>
    </div>



<script>
    function abrirChat() {
        document.getElementById("janelaChat").style.display = "flex";
    }

    function fecharChat() {
        document.getElementById("janelaChat").style.display = "none";
    }

    function obterHoraAtual() {
        const options = {
            timeZone: 'America/Sao_Paulo',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        const agora = new Date();
        return agora.toLocaleTimeString('pt-BR', options);
    }

    async function gerarResposta() {
        const pergunta = document.getElementById('entradaUsuario').value;

        var entrada = document.getElementById("entradaUsuario");
        var mensagem = entrada.value.trim();

        const response = await fetch('/perguntar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pergunta })
        });

        const data = await response.json();

        conversa.push(mensagem)
        conversa.push(data.resultado)

        if (mensagem !== "") {
            var mensagemUsuario = document.createElement("div");
            mensagemUsuario.classList.add("mensagem", "usuario");
            mensagemUsuario.innerText = mensagem;
            document.getElementById("corpoChat").appendChild(mensagemUsuario);

            var horaUsuario = document.createElement("div");
            horaUsuario.classList.add("hora-mensagem");
            horaUsuario.innerText = obterHoraAtual();
            document.getElementById("corpoChat").appendChild(horaUsuario);

            entrada.value = "";

            setTimeout(function () {
                var mensagemAssistente = document.createElement("div");
                mensagemAssistente.classList.add("mensagem", "assistente");
                mensagemAssistente.innerText = data.resultado;
                document.getElementById("corpoChat").appendChild(mensagemAssistente);

                var horaAssistente = document.createElement("div");
                horaAssistente.classList.add("hora-mensagem", "assistente");
                horaAssistente.innerText = obterHoraAtual();
                document.getElementById("corpoChat").appendChild(horaAssistente);

                document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
            }, 1000);

            document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
        }
    }
  
// Função para monitorar os dados (alertas para valores baixos)
function monitorarDados() {
    const minBytes = 1024 * 1024; // 1 MB em bytes
    const minPacotes = 10;
    const maxPing = 100; // Latência máxima permitida

    // Dados fictícios para teste (pode ser substituído por valores reais)
    const ping = 993;
    const bytesEnviados = 500000;
    const bytesRecebidos = 920000;
    const pacotesEnviados = 5;
    const pacotesRecebidos = 8;

    // Conversões para MB
    const bytesEnviadosMB = (bytesEnviados / (1024 * 1024)).toFixed(2);
    const bytesRecebidosMB = (bytesRecebidos / (1024 * 1024)).toFixed(2);

    // Referências aos elementos HTML
    const perdaBytesElem = document.getElementById("perdaBytes");
    const perdaPacotesElem = document.getElementById("perdaPacotes");
    const pingAlertaElem = document.getElementById("pingAlerta");

    // Inicializa mensagens
    let perdaBytesMsg = "";
    let perdaPacotesMsg = "";
    let pingMsg = "";

    // Verificações e acúmulo de alertas
    if (bytesEnviados < minBytes) {
        perdaBytesMsg += `${bytesEnviadosMB} MB enviados (Alerta: Abaixo de 1 MB)<br>`;
    }
    if (bytesRecebidos < minBytes) {
        perdaBytesMsg += `<br>${bytesRecebidosMB} MB recebidos (Alerta: Abaixo de 1 MB)<br>`;
    }
    if (pacotesEnviados < minPacotes) {
        perdaPacotesMsg += `<br>${pacotesEnviados} pacotes enviados (Alerta: Abaixo de 10 pacotes)<br>`;
    }
    if (pacotesRecebidos < minPacotes) {
        perdaPacotesMsg += `<br>${pacotesRecebidos} pacotes recebidos (Alerta: Abaixo de 10 pacotes)<br>`;
    }
    if (ping > maxPing) {
        pingMsg += `<br>${ping} ms (Alerta: Latência acima de 100 ms)<br>`;
    }

    // Atualiza os elementos HTML
    atualizarTextoElemento("perdaBytes", perdaBytesMsg || "Nenhum alerta", perdaBytesMsg ? "#E74C3C" : "lightgreen");
    atualizarTextoElemento("perdaPacotes", perdaPacotesMsg || "Nenhum alerta", perdaPacotesMsg ? "#E74C3C" : "lightgreen");
    atualizarTextoElemento("pingAlerta", pingMsg || "Nenhum alerta", pingMsg ? "#E74C3C" : "lightgreen");
}
var fkEquipamento = 2; // Atualiza a data quando a página carrega
function fetchDadosChartPackets(fkEquipamento) {
    fetch(`/ale/obterDados/${fkEquipamento}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                atualizarGraficoPackets(data);
            } else {
                console.error('Formato de dados inesperado:', data);
            }
        })
        .catch(error => console.error('Falha ao capturar dados de pacotes:', error));
}

let chartPackets;
function atualizarGraficoPackets(data) {
    const momentos = data.map(item => {
        const dtHora = new Date(item.momento);
        dtHora.setHours(dtHora.getHours() - 3);
        return dtHora.toISOString();
    });
    const pacotes = data.map(item => item.pacotes);

    if (!chartPackets) {
        const options = {
            series: [{
                name: 'Pacotes de Dados',
                data: pacotes
            }],
            chart: {
                type: 'line',
                height: 350,
                zoom: { enabled: false },
                background: '#292930',
            },
            xaxis: {
                type: 'datetime',
                categories: momentos,
                labels: {
                    format: 'HH:mm',
                    style: {
                        color: 'white',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val.toFixed(0); // Exibindo número de pacotes
                    },
                    style: {
                        color: 'white'
                    }
                },
                title: {
                    text: 'Pacotes de Dados',
                    style: {
                        color: 'white'
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toFixed(0);
                    }
                }
            }
        };

        chartPackets = new ApexCharts(document.querySelector("#chartPackets"), options);
        chartPackets.render();
    } else {
        chartPackets.updateSeries([{
            name: 'Pacotes de Dados',
            data: pacotes
        }]);
    }
}
fetchDadosChartPackets(fkEquipamento);
function fetchDadosChartPie(fkEquipamento) {
    fetch(`/ale/obterDados/${fkEquipamento}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                atualizarGraficoPie(data);
            } else {
                console.error('Formato de dados inesperado:', data);
            }
        })
        .catch(error => console.error('Falha ao capturar dados do gráfico pie:', error));
}

let chartPie;
function atualizarGraficoPie(data) {
    const categorias = data.map(item => item.categoria);
    const valores = data.map(item => item.valor);

    if (!chartPie) {
        const options = {
            series: valores,
            chart: {
                type: 'pie',
                height: 350,
                background: '#292930'
            },
            labels: categorias,
            colors: ['#FFDC60', '#73B7FF', '#FF4560'],
            title: {
                text: 'Distribuição de Pacotes',
                style: {
                    color: 'white',
                    fontSize: '16px'
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toFixed(0);
                    }
                }
            }
        };

        chartPie = new ApexCharts(document.querySelector("#chartPie"), options);
        chartPie.render();
    } else {
        chartPie.updateSeries(valores);
    }
}
fetchDadosChartPie(fkEquipamento);
function fetchDadosChartBytes(fkEquipamento) {
    fetch(`/ale/obterDados/${fkEquipamento}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                atualizarGraficoBytes(data);
            } else {
                console.error('Formato de dados inesperado:', data);
            }
        })
        .catch(error => console.error('Falha ao capturar dados de bytes:', error));
}

let chartBytes;
function atualizarGraficoBytes(data) {
    const momentos = data.map(item => {
        const dtHora = new Date(item.momento);
        dtHora.setHours(dtHora.getHours() - 3);
        return dtHora.toISOString();
    });
    const bytes = data.map(item => item.bytes);

    if (!chartBytes) {
        const options = {
            series: [{
                name: 'Bytes de Dados',
                data: bytes
            }],
            chart: {
                type: 'line',
                height: 350,
                zoom: { enabled: false },
                background: '#292930'
            },
            xaxis: {
                type: 'datetime',
                categories: momentos,
                labels: {
                    format: 'HH:mm',
                    style: {
                        color: 'white',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val.toFixed(0);
                    },
                    style: {
                        color: 'white'
                    }
                },
                title: {
                    text: 'Bytes de Dados',
                    style: {
                        color: 'white'
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toFixed(0);
                    }
                }
            }
        };

        chartBytes = new ApexCharts(document.querySelector("#chartBytes"), options);
        chartBytes.render();
    } else {
        chartBytes.updateSeries([{
            name: 'Bytes de Dados',
            data: bytes
        }]);
    }
}
fetchDadosChartBytes(fkEquipamento);
function fetchDadosChartCPU(fkEquipamento) {
    fetch(`/ale/obterDados/${fkEquipamento}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                atualizarGraficoCPU(data);
            } else {
                console.error('Formato de dados inesperado:', data);
            }
        })
        .catch(error => console.error('Falha ao capturar dados de CPU:', error));
}

let chartCPU;
function atualizarGraficoCPU(data) {
    const momentos = data.map(item => {
        const dtHora = new Date(item.momento);
        dtHora.setHours(dtHora.getHours() - 3);
        return dtHora.toISOString();
    });
    const valoresCPU = data.map(item => item.cpuPercent);

    if (!chartCPU) {
        const options = {
            series: [{
                name: 'Uso de CPU',
                data: valoresCPU
            }],
            chart: {
                type: 'area',
                height: 350,
                zoom: { enabled: false },
                background: '#292930'
            },
            xaxis: {
                type: 'datetime',
                categories: momentos,
                labels: {
                    format: 'HH:mm',
                    style: {
                        color: 'white',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val.toFixed(0) + '%';
                    },
                    style: {
                        color: 'white'
                    }
                },
                title: {
                    text: 'Uso de CPU (%)',
                    style: {
                        color: 'white'
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toFixed(0) + '%';
                    }
                }
            }
        };

        chartCPU = new ApexCharts(document.querySelector("#chartCPU"), options);
        chartCPU.render();
    } else {
        chartCPU.updateSeries([{
            name: 'Uso de CPU',
            data: valoresCPU
        }]);
    }
}
fetchDadosChartCPU(fkEquipamento);
setInterval(() => {
    fetchDadosChartPackets(fkEquipamento);
    fetchDadosChartPie(fkEquipamento);
    fetchDadosChartBytes(fkEquipamento);
    fetchDadosChartCPU(fkEquipamento);
}, 300000);  // 300000ms = 5 minutos

</script>

</body>

</html>