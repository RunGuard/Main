<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD-Diego | RunGuard</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/dashstyle.css">
    <link rel="stylesheet" href="css/style_diego.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="atualizarGrafico()">
    <button class="botao-chat" onclick="abrirChat()"><img style="width: 6vh;" src="imagens/robo.png" alt=""></button>

    <div id="janelaChat" class="janela-chat">
        <div class="cabecalho-chat">
            <div style="display: flex; align-items: center;">
                <img style="width: 100%;" src="imagens/robo-branco.png" alt="Perfil do assistente">
                <span style="font-size: 1.5em;">Guardinha</span>
            </div>
            <!-- add imagem de um X -->
            <button style="background: none; border: none; color: white; cursor: pointer; font-size: 2em;"
                onclick="fecharChat()">᰽</button>
        </div>
        <div id="corpoChat" class="corpo-chat">
            <div class="mensagem assistente">
                Olá! <br>
                Me chamo Guardinha e sou a assistente virtual da RunGuard. <br>
                <b>Como posso ajudar?</b>
            </div>
            <div class="hora-mensagem assistente" id="horaDeAbertura"></div> <!-- add pelo id a hora -->
        </div>
        <div class="rodape-chat">
            <input type="text" id="entradaUsuario" placeholder="Escreva sua mensagem..." />
            <button onclick="gerarResposta()">⟹</button>
        </div>
    </div>

    <nav>
        <ul>
            <li>
                <a href="index.html" class="logo">
                    <img src="imagens/logo.png" alt="Logo RunGuard">
                    <span class="nav-item">RUNGUARD</span>
                </a>
            </li>
            <li><a href="index.html">
                    <i class="fas fa-home"></i>
                    <span class="nav-item">Home</span>
                </a></li>
            <li><a href="Dashboard - Ale.html">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item">Dashboard 1</span>
                </a></li>
            <li><a href="Dashboard - Anne.html">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-item">Dashboard 2</span>
                </a></li>
            <li><a href="Dashboard - Diego.html">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-item">Dashboard 3</span>
                </a></li>
            <li><a href="Dashboard - Guilherme.html">
                    <i class="fas fa-chart-column"></i>
                    <span class="nav-item">Dashboard 4</span>
                </a></li>
            <li><a href="Dashboard - Ilys.html">
                    <i class="fas fa-chart-simple"></i>
                    <span class="nav-item">Dashboard 5</span>
                </a></li>
            <li><a href="Dashboard - Lucas.html">
                    <i class="fas fa-chart-area"></i>
                    <span class="nav-item">Dashboard 6</span>
                </a></li>
            <li> <a href="insights-run-guard.pdf" download>
                    <i class="fas fa-file-pdf"></i>
                    <span class="nav-item">Baixe seus relatórios!</span>
                </a></li>
            <li><a href="#" class="sair">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-item">Sair</span>
                </a></li>
        </ul>
    </nav>
    <div class="fantasma">a</div>

    <div class="content d-flex column jc-space-between">
        <div class="d-flex row content2 jc-space-between">
            <div class="d-flex column ai-center padding filtro">
                <h2>Selecione o intervalo entre os meses para monitorar</h2>
                <div class="range-container">
                    <div class="output">
                        <span id="minValue">1</span>
                        <span id="maxValue">12</span>
                    </div>

                    <div class="range-background"></div>
                    <div class="range-fill" id="rangeFill"></div>

                    <!-- Range esquerdo -->
                    <input type="range" min="1" max="12" value="1" id="rangeMin"
                        oninput="updateRange(), atualizarGrafico()">
                    <!-- Range direito -->
                    <input type="range" min="1" max="12" value="12" id="rangeMax"
                        oninput="updateRange(), atualizarGrafico()">

                    <div class="tickmarks">
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                        <span>|</span>
                    </div>
                </div>
            </div>
            <div class="previsto ai-center d-flex column jc-space-around">
                <p><span>Próxima</span> quantidade de alertas prevista:</p>
                <h1 id="previsao"> </h1>
            </div>
        </div>

        <div class="medias pad font-media">
            <div class="ultima-medida media">
                <p><span>Quantidade </span>de alertas no<span> período selecionado</span></p>
                <hr>
                <p class="alerta-info">24</p>
            </div>
            <div class="d-flex column ai-center media">
                <p><span>Quantidade </span>total de alertas no<span> último ano</span></p>
                <hr>
                <p class="alerta-info">100</p>
            </div>
            <div class="media as-center">
                <p><span>Servidor</span> com mais alerta no <span>período selecionado</span></p>
                <hr>
                <p class="alerta-info">S1 <span style="color: #fff; font-size: 0.6em;">/ 20</span><span
                        style="font-size: 0.6em;"> alertas</span></p>
            </div>
        </div>
        
        
        
        <div class="d-flex row jc-space-between pad">
            <div class="grafico as-center">
                <div id="chart"></div>
            </div>
            <div class="ranking as-center">
                <table class="font-media">
                    <caption>Ranking de servidores com mais alertas</caption>
                    <tr style="color: #ffdc60;">
                        <th>Ranking</th>
                        <th>Servidor</th>
                        <th>Total alertas</th>
                    </tr>
                    <tr>
                        <td>1°</td>
                        <td>S1</td>
                        <td>30</td>
                    </tr>
                    <tr>
                        <td>2°</td>
                        <td>S2</td>
                        <td>14</td>
                    </tr>
                    <tr>
                        <td>3°</td>
                        <td>S3</td>
                        <td>6</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

</html>
</body>

<script>
    meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]

    function updateRange() {
        const minRange = document.getElementById('rangeMin');
        const maxRange = document.getElementById('rangeMax');
        const minValue = parseInt(minRange.value);
        const maxValue = parseInt(maxRange.value);
        const rangeFill = document.getElementById('rangeFill');

        if (minValue >= maxValue) {
            minRange.value = maxValue - 1;
        }
        if (maxValue <= minValue) {
            maxRange.value = minValue + 1;
        }

        document.getElementById('minValue').textContent = meses[minValue - 1];
        document.getElementById('maxValue').textContent = meses[maxValue - 1];

        const minPercent = (minRange.value / minRange.max) * 100;
        const maxPercent = (maxRange.value / maxRange.max) * 100;
        rangeFill.style.left = minPercent - 3.5 + '%';
        rangeFill.style.width = (maxPercent - minPercent) + '%';
    }
    updateRange();

    function multiplicar(x, y) {
    var ret = [];
    for ( var i = 0 ; i < x.length ; i++ )
        ret.push(x[i] * y[i]);
    return ret;
    }

    function quadrado(x) {
    var ret = [];
    for ( var i = 0 ; i < x.length ; i++ )
        ret.push(x[i] * x[i]);
    return ret;
    }

    function somar(x) {
    var ret = 0;
    for ( var i = 0 ; i < x.length ; i++ )
        ret += x[i];
    return ret;
    }

    function media(x) { 
        return somar(x) / x.length; 
    }

    function calcularR2(x, y) {
        const n = x.length;
        const mediaX = media(x);
        const mediaY = media(y);

        let numerador = somar(multiplicar(
            x.map(xi => xi - mediaX),
            y.map(yi => yi - mediaY)
        ));

        let somaQuadradoX = somar(quadrado(x.map(xi => xi - mediaX)));
        let somaQuadradoY = somar(quadrado(y.map(yi => yi - mediaY)));
        const denominador = Math.sqrt(somaQuadradoX * somaQuadradoY);

        const r = numerador / denominador;

        const r2 = Math.pow(r,2)
        return r2;
    }

    async function atualizarGrafico() {

        fetch("/dashboard-Diego/atualizarGrafico", { 
            cache: 'no-store',
            method: "GET",
         })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            }
            return response.json();
        })
        .then(dado => {
            console.log(dado)
        })
        
        var data = [22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44]
        var categoria = []
        var categoriaNum = []
        const minRange = document.getElementById('rangeMin');
        const maxRange = document.getElementById('rangeMax');
        const minValue = parseInt(minRange.value);
        const maxValue = parseInt(maxRange.value);

        for (var i = minValue - 1; i < maxValue; i++) {
            categoria.push(meses[i])
            categoriaNum.push(i+1)
        }

        console.log(categoria)
        console.log(categoriaNum)

        var x = categoriaNum;
        var y = data;

        var m = (somar(multiplicar(x, y)) - (somar(x) * somar(y)) / x.length) / 
        (somar(quadrado(x)) - (somar(x) * somar(x)) / x.length);
        var b = media(y) - m * media(x);

        var r2 = (calcularR2(x, y) * 100).toFixed()

        document.getElementById("previsao").innerHTML = `${(m*13 + b).toFixed()}<span id="rquadrado"></span>`
        document.getElementById("rquadrado").innerHTML = `  Precisão: ${r2}%`

        document.getElementById("chart").innerHTML = ""
        var options = {
            series: [{
                name: 'Alertas',
                data: data
            }],
            chart: {
                type: 'bar',
                height: 400,
                width: 600,
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                },
            },
            colors: ['#ffdc60'],
            title: {
                text: 'Quantidade de alertas no período selecionado',
                align: 'center',
                style: {
                    color: 'white'
                }
            },
            dataLabels: {
                enabled: true,
                style: {
                    color: '#000'
                }
            },
            stroke: {
                show: false,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: categoria,
                labels: {
                    style: {
                        colors: Array(categoria.length).fill('white'),
                        weight: 400
                    }
                },
            },
            yaxis: {
                labels: {
                    style: {
                        colors: Array(categoria.length).fill('#696969')
                    },
                },
                min: 0,
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val + " alertas"
                    },
                    title: {
                        formatter: function (seriesName) {
                            return seriesName + ':';
                        },
                        style: {
                            color: '#fff'
                        }
                    }
                },
                style: {
                    fontSize: '14px',
                    fontFamily: 'Arial, sans-serif',
                    color: '#fff'
                },
                theme: 'dark'
            }
        };
        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }

    function abrirChat() {
        document.getElementById("janelaChat").style.display = "flex";
    }

    function fecharChat() {
        document.getElementById("janelaChat").style.display = "none";
    }

    function obterHoraAtual() {
        const options = {
            timeZone: 'America/Sao_Paulo',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        const agora = new Date();
        return agora.toLocaleTimeString('pt-BR', options);
    }

    async function gerarResposta() {
        const pergunta = document.getElementById('entradaUsuario').value;

        var entrada = document.getElementById("entradaUsuario");
        var mensagem = entrada.value.trim();

        const response = await fetch('/perguntar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pergunta })
        });

        const data = await response.json();

        conversa.push(mensagem)
        conversa.push(data.resultado)

        if (mensagem !== "") {
            var mensagemUsuario = document.createElement("div");
            mensagemUsuario.classList.add("mensagem", "usuario");
            mensagemUsuario.innerText = mensagem;
            document.getElementById("corpoChat").appendChild(mensagemUsuario);

            var horaUsuario = document.createElement("div");
            horaUsuario.classList.add("hora-mensagem");
            horaUsuario.innerText = obterHoraAtual();
            document.getElementById("corpoChat").appendChild(horaUsuario);

            entrada.value = "";

            setTimeout(function () {
                var mensagemAssistente = document.createElement("div");
                mensagemAssistente.classList.add("mensagem", "assistente");
                mensagemAssistente.innerText = data.resultado;
                document.getElementById("corpoChat").appendChild(mensagemAssistente);

                var horaAssistente = document.createElement("div");
                horaAssistente.classList.add("hora-mensagem", "assistente");
                horaAssistente.innerText = obterHoraAtual();
                document.getElementById("corpoChat").appendChild(horaAssistente);

                document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
            }, 1000);

            document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
        }
    }
</script>