<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD-Lucas | RunGuard</title>
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/styleroque.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
    <button class="botao-chat" onclick="abrirChat()"><img style="width: 6vh;" src="imagens/robo.png" alt=""></button>

    <div id="janelaChat" class="janela-chat">
        <div class="cabecalho-chat">
            <div style="display: flex; align-items: center;">
                <img style="width: 100%;" src="imagens/robo-branco.png" alt="Perfil do assistente">
                <span style="font-size: 1.5em;">Guardinha</span>
            </div>
            <!-- add imagem de um X -->
            <button style="background: none; border: none; color: white; cursor: pointer; font-size: 2em;"
                onclick="fecharChat()">᰽</button>
        </div>
        <div id="corpoChat" class="corpo-chat">
            <div class="mensagem assistente">
                Olá! <br>
                Me chamo Guardinha e sou a assistente virtual da RunGuard. <br>
                <b>Como posso ajudar?</b>
            </div>
            <div class="hora-mensagem assistente" id="horaDeAbertura"></div> <!-- add pelo id a hora -->
        </div>
        <div class="rodape-chat">
            <input type="text" id="entradaUsuario" placeholder="Escreva sua mensagem..." />
            <button onclick="gerarResposta()">⟹</button>
        </div>
    </div>

    <nav>
        <ul>
            <li>
                <a href="index.html" class="logo">
                    <img src="imagens/logo.png" alt="Logo RunGuard">
                    <span class="nav-item">RUNGUARD</span>
                </a>
            </li>
            <li><a href="index.html">
                    <i class="fas fa-home"></i>
                    <span class="nav-item">Home</span>
                </a></li>
            <li><a href="Dashboard - Ale.html">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item">Dashboard 1</span>
                </a></li>
            <li><a href="Dashboard - Anne.html">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-item">Dashboard 2</span>
                </a></li>
            <li><a href="Dashboard - Diego.html">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-item">Dashboard 3</span>
                </a></li>
            <li><a href="Dashboard - Guilherme.html">
                    <i class="fas fa-chart-column"></i>
                    <span class="nav-item">Dashboard 4</span>
                </a></li>
            <li><a href="Dashboard - Ilys.html">
                    <i class="fas fa-chart-simple"></i>
                    <span class="nav-item">Dashboard 5</span>
                </a></li>
            <li><a href="Dashboard - Lucas.html">
                    <i class="fas fa-chart-area"></i>
                    <span class="nav-item">Dashboard 6</span>
                </a></li>
            <li> <a href="insights-run-guard.pdf" download>
                    <i class="fas fa-file-pdf"></i> 
                    <span class="nav-item">Baixe seus relatórios!</span>
            </a></li>
            <li><a href="#" class="sair">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-item">Sair</span>
                </a></li>
        </ul>
    </nav>
    <div class="fundo">
        <div class="titulo">
            <h1>Monitoramento de Desvio e Demanda</h1>
        </div>
        <div class="alinhamento">
        <div class="fundografico">
            <div id="grafico1"></div>
        </div>
        <div class="fundografico">
          <div id="grafico2"></div>
        </div>
        <div class="fundografico">
          <div id="grafico3"></div>
        </div>
      </div>
      <div class="titulo">
        <h1>KPI's para fácil entendimento dos gráficos</h1>
    </div>

    <div class="alinharcards">
      <div class="alinhamento2">
       
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-left: 230px;">
            <!-- Card para Desvio Padrão de CPU -->
            <div class="card">
                <div class="card-title">Desvio Padrão CPU</div>
                <div id="desviopadraocpu"></div>
            </div>
        
            <!-- Card para Desvio Padrão de Memória RAM -->
            <div class="card">
                <div class="card-title">Desvio Padrão Memória RAM</div>
                <div id="desviopadraoram"></div>
            </div>
        
            <!-- Card para Taxa de Uso de I/O de Disco -->
            <div class="card">
                <div class="card-title">Taxa de I/O Disco</div>
                <div id="iodisco">75%</div>
            </div>
        
            <!-- Card para Downtime -->
            <div class="card">
                <div class="card-title">Downtime</div>
                <div id="downtimetempo">120 min</div>
            </div>
        </div>

        <div class="alinhamento3">
            <div class="kpi-cards-container">
                <!-- Índice de Estabilidade do Servidor (ISS) -->
                <div class="kpi-card">
                    <h2>Índice de Estabilidade do Servidor</h2>
                    <p id="estabilidade">95%</p>
                    <p class="kpi-description">Mede a estabilidade geral do servidor com base no desvio padrão de CPU e Memória RAM.</p>
                </div>
            
                <!-- Índice de Eficiência de I/O e CPU (IEIC) -->
                <div class="kpi-card">
                    <h2>Índice de Eficiência de I/O e CPU</h2>
                    <p id="kpi-value">85%</p>
                    <p class="kpi-description">Relaciona a eficiência do uso de I/O com a estabilidade da CPU.</p>
                </div>
            
                <!-- Taxa de Recuperação Pós-Downtime (TRPD) -->
                <div class="kpi-card">
                    <h2>Taxa de Recuperação Pós-Downtime</h2>
                    <p id="kpi-value">78%</p>
                    <p class="kpi-description">Avalia a capacidade do servidor de estabilizar CPU e Memória RAM após downtime.</p>
                </div>
            </div>            
        </div>
    </div>
      </div>
    </div>
</html>
</body>
<script>
var fkEquipamento = 1;


function buscarDadosGrafico(fkEquipamento) {
    fetch(`/rotaRoque/ultimaMedida/${fkEquipamento}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao buscar dados: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (Array.isArray(data)) {
                atualizarGrafico1(data);
                atualizarGrafico2(data);
                atualizarGrafico3(data);
            } else {
                console.error('Formato de dados inesperado:', data);
            }
        })
        .catch(error => {
            console.error("Erro ao buscar dados: ", error);
        });
}

function atualizarGrafico1(data) {

    const momentos = data.map(item => {
    const dtHora = new Date(item.momento); 
    dtHora.setHours(dtHora.getHours() - 3); 
    return dtHora.toISOString();
    });

    const desvioPadraoCpu = data.map(item => item.desvio_padrao_cpu);
    const desvioPadraoMemoria = data.map(item => item.desvio_padrao_memoria);

    const indiceEstabilidade = data.map(item => item.indiceEstabilidade);

    document.getElementById("desviopadraocpu").innerHTML = desvioPadraoCpu[desvioPadraoCpu.length - 1] + "%";
    document.getElementById("desviopadraoram").innerHTML = desvioPadraoMemoria[desvioPadraoMemoria.length - 1] + "%";

    var options = {
        series: [
            {
                name: 'Desvio Padrão de CPU',
                data: desvioPadraoCpu
            },
            {
                name: 'Desvio Padrão de Memória RAM',
                data: desvioPadraoMemoria
            }
        ],
        chart: {
            height: 350,
            type: 'line', 
            dropShadow: {
                enabled: true,
                color: '#000',
                top: 18,
                left: 7,
                blur: 10,
                opacity: 0.2
            },
            zoom: {
                enabled: false  
            },
            toolbar: {
                show: false  
            },
            background: '#292930', 
        },
        colors: ['#FFD700', '#FFEA00'], 
        dataLabels: {
            enabled: true  
        },
        stroke: {
            curve: 'smooth' 
        },
        title: {
            text: `Desvio Padrão de CPU e Memória RAM - Última Medida: ${momentos[momentos.length - 1]}`,
            align: 'left',
            style: {
                color: '#FFFFFF',  
                fontSize: '16px'
            }
        },
        grid: {
            borderColor: '#444',  
            row: {
                colors: ['#555', 'transparent'],  
                opacity: 0.5
            }
        },
        markers: {
            size: 5, 
            colors: ['#FFD700', '#FFEA00'],
            strokeColor: '#fff',
            strokeWidth: 2
        },
        xaxis: {
            type: 'datetime',  
            categories: momentos,  
            title: {
                text: 'Hora',
                style: {
                    color: '#FFFFFF'  
                }
            },
            labels: {
                style: {
                    colors: ['#FFFFFF']  
                }
            }
        },
        yaxis: {
            title: {
                text: 'Desvio Padrão',
                style: {
                    color: '#FFD700'  
                }
            },
            labels: {
                style: {
                    colors: ['#FFD700']  
                }
            },
            min: 0,
            max: 20 
        },
        legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5,
            labels: {
                colors: '#FFFFFF'  
            }
        },
        tooltip: {
            x: {
                format: 'dd/MM/yy HH:mm' 
            },
            style: {
                fontSize: '12px',
                color: '#FFFFFF' 
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#grafico1"), options);
    chart.render();
}




function atualizarGrafico2(data) {
    const usoIoTotal = data.map(item => item.uso_io_total);

    document.getElementById("iodisco").innerHTML = usoIoTotal[usoIoTotal.length - 1] + " Bytes";
    
    var options = {
        series: [{
            name: 'Uso I/O Disco 1',
            data: usoIoTotal,
        }, {
            name: 'Uso I/O Disco 2',
            data: usoIoTotal,  
        }],
        chart: {
            height: 350,
            type: 'area',
            dropShadow: {
                enabled: true,
                top: 10,
                left: 5,
                blur: 3,
                color: '#000',
                opacity: 0.2
            },
            zoom: {
                enabled: false
            }
        },
        colors: ['#ffbb33', '#ffbb33'],
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth'
        },
        title: {
            text: 'Monitoramento da Taxa de Uso de I/O de Disco',
            align: 'left',
            style: {
                fontSize: '18px',
                color: '#FFFFFF'
            }
        },
        xaxis: {
            type: 'datetime',
            categories: [
                "2024-10-01T00:00:00.000Z",
                "2024-10-01T01:30:00.000Z",
                "2024-10-01T02:30:00.000Z",
                "2024-10-01T03:30:00.000Z",
                "2024-10-01T04:30:00.000Z",
                "2024-10-01T05:30:00.000Z",
                "2024-10-01T06:30:00.000Z"
            ],
            labels: {
                format: 'HH:mm',
                style: {
                    colors: '#FFFFFF'
                }
            },
            title: {
                text: 'Horário',
                style: {
                    color: '#FFFFFF'
                }
            }
        },
        yaxis: {
            min: 0,
            max: 100,
            title: {
                text: 'Taxa de Uso (%)',
                style: {
                    color: '#FFFFFF'
                }
            },
            labels: {
                style: {
                    colors: '#FFFFFF'
                }
            }
        },
        tooltip: {
            x: {
                format: 'dd/MM/yy HH:mm'
            }
        },
        grid: {
            borderColor: '#555',
            row: {
                colors: ['transparent', 'rgba(255, 255, 255, 0.1)'],
                opacity: 0.5
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'right',
            labels: {
                colors: '#FFFFFF'
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#grafico2"), options);
    chart.render();
}

function atualizarGrafico3(data) {
    const downtime = data.map(item => item.tempo_downtime);

    document.getElementById("downtimetempo").innerHTML = downtime[downtime.length - 1] + " Min";

    
    var options = {
        series: [{
            data: downtime
        }],
        chart: {
            type: 'bar',
            height: 350,
            toolbar: {
                show: false
            },
        },
        colors: ['#FFD700'],
        title: {
            text: 'Monitoramento de Downtime',
            align: 'left',
            style: {
                color: '#FFFFFF',
                fontSize: '20px'
            }
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                borderRadiusApplication: 'end',
                horizontal: true,
            }
        },
        dataLabels: {
            enabled: true,
            style: {
                colors: ['#FFFFFF']
            }
        },
        xaxis: {
            categories: [
                'Janeiro',
                'Fevereiro',
                'Março',
                'Abril',
                'Maio',
                'Junho',
                'Julho',
                'Agosto',
                'Setembro',
                'Outubro',
                'Novembro',
                'Dezembro'
            ],
            labels: {
                style: {
                    color: '#fff'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    color: '#FFFFFF'
                }
            }
        },
        tooltip: {
            y: {
                formatter: function (val) {
                    return val + " minutos";
                }
            }
        },
        legend: {
            labels: {
                colors: '#FFFFFF'
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#grafico3"), options);
    chart.render();
}

buscarDadosGrafico(fkEquipamento);


    function abrirChat() {
        document.getElementById("janelaChat").style.display = "flex";
    }

    function fecharChat() {
        document.getElementById("janelaChat").style.display = "none";
    }

    function obterHoraAtual() {
        const options = {
            timeZone: 'America/Sao_Paulo',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        const agora = new Date();
        return agora.toLocaleTimeString('pt-BR', options);
    }
        
    async function gerarResposta() {
      const pergunta = document.getElementById('entradaUsuario').value;

      var entrada = document.getElementById("entradaUsuario");
      var mensagem = entrada.value.trim();

      const response = await fetch('/perguntar', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pergunta })
        });

      const data = await response.json();

      conversa.push(mensagem)
      conversa.push(data.resultado)

        if (mensagem !== "") {
            var mensagemUsuario = document.createElement("div");
            mensagemUsuario.classList.add("mensagem", "usuario");
            mensagemUsuario.innerText = mensagem;
            document.getElementById("corpoChat").appendChild(mensagemUsuario);

            var horaUsuario = document.createElement("div");
            horaUsuario.classList.add("hora-mensagem");
            horaUsuario.innerText = obterHoraAtual();
            document.getElementById("corpoChat").appendChild(horaUsuario);

            entrada.value = "";

            setTimeout(function() {
                var mensagemAssistente = document.createElement("div");
                mensagemAssistente.classList.add("mensagem", "assistente");
                mensagemAssistente.innerText = data.resultado;
                document.getElementById("corpoChat").appendChild(mensagemAssistente);

                var horaAssistente = document.createElement("div");
                horaAssistente.classList.add("hora-mensagem", "assistente");
                horaAssistente.innerText = obterHoraAtual();
                document.getElementById("corpoChat").appendChild(horaAssistente);

                document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
            }, 1000);

            document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
        }
    }
</script>