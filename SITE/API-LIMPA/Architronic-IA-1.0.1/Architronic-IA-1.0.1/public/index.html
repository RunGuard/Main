<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architronic-IA</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>

    
<button class="botao-chat" onclick="abrirChat()"><img style="width: 6vh;" src="robo.png" alt=""></button>

<div id="janelaChat" class="janela-chat">
    <div class="cabecalho-chat">
        <div style="display: flex; align-items: center;">
            <img style="width: 100%;" src="robo-branco.png" alt="Perfil do assistente">
            <span>Guardinha</span>
        </div>
        <!-- add imagem de um X -->
        <button style="background: none; border: none; color: white; cursor: pointer; font-size: larger;" onclick="fecharChat()">᰽</button> 
    </div>
    <div id="corpoChat" class="corpo-chat">
        <div class="mensagem assistente">
            Olá! <br> 
            Sou o assistente virtual da RunGuard e me chamo Guardinha. <br>
            <b>Como posso ajudar?</b>
        </div>
        <div class="hora-mensagem assistente" id="horaDeAbertura"></div> <!-- add pelo id a hora -->
    </div>
    <div class="rodape-chat">
        <input type="text" id="entradaUsuario" placeholder="Escreva sua mensagem..." />
        <button onclick="gerarResposta()">⟹</button>
    </div>
</div>

<script>
  var conversa = []

    function abrirChat() {
        document.getElementById("janelaChat").style.display = "flex";
    }

    function fecharChat() {
        document.getElementById("janelaChat").style.display = "none";
    }

    function obterHoraAtual() {
        const options = {
            timeZone: 'America/Sao_Paulo',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        const agora = new Date();
        return agora.toLocaleTimeString('pt-BR', options);
    }
        
    async function gerarResposta() {
      const pergunta = document.getElementById('entradaUsuario').value;

      var entrada = document.getElementById("entradaUsuario");
      var mensagem = entrada.value.trim();

      const response = await fetch('/perguntar', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pergunta })
        });

      const data = await response.json();

      conversa.push(mensagem)
      conversa.push(data.resultado)

        if (mensagem !== "") {
            var mensagemUsuario = document.createElement("div");
            mensagemUsuario.classList.add("mensagem", "usuario");
            mensagemUsuario.innerText = mensagem;
            document.getElementById("corpoChat").appendChild(mensagemUsuario);

            var horaUsuario = document.createElement("div");
            horaUsuario.classList.add("hora-mensagem");
            horaUsuario.innerText = obterHoraAtual();
            document.getElementById("corpoChat").appendChild(horaUsuario);

            entrada.value = "";

            setTimeout(function() {
                var mensagemAssistente = document.createElement("div");
                mensagemAssistente.classList.add("mensagem", "assistente");
                mensagemAssistente.innerText = data.resultado;
                document.getElementById("corpoChat").appendChild(mensagemAssistente);

                var horaAssistente = document.createElement("div");
                horaAssistente.classList.add("hora-mensagem", "assistente");
                horaAssistente.innerText = obterHoraAtual();
                document.getElementById("corpoChat").appendChild(horaAssistente);

                document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
            }, 1000);

            document.getElementById("corpoChat").scrollTop = document.getElementById("corpoChat").scrollHeight;
        }
    }

    </script>
    
</body>
</html>
